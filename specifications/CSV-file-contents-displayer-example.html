<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>CSV-file contents displayer example</title>
<style>
#fileInfo {
  border: 1px solid #000;
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  padding: 5px;
  visibility:hidden;
}
#progHolder {
  float:right;
  width:200px;
  height:30px;
  border:solid;
  border-width:1px;
  background-color:#999;
  text-align:center;
}
#progMeter {
  width:0px;
  height:30px;
  background-color:#9FF;
}
#btnCancel {
  visibility:hidden;
}
</style>
<script>
// set up a filereader
var textReader = new FileReader();

function init() {
  // set up filereader handlers
  textReader.onerror     = onErrorHandler;
  textReader.onprogress  = updateProgress;
  textReader.onabort     = onAbortHandler;
  textReader.onloadstart = onLoadStartHandler;
  textReader.onload      = onLoadHandler;
}

// handle the selected file
function handleFile(inputFile) {

  // the csv mime type for regular expression
  var csvMimeType = /text\/csv/;

  // reference the selected file
  var file = inputFile.files[0];

  // verify that the file is a csv file
  if (file.type.match(csvMimeType)) {

    // make the file info section visible
    var fileInfo = document.getElementById("fileInfo");
    fileInfo.style.visibility = 'visible';

    // kick off the reader to read the csv file
    textReader.readAsText(file);

    // set our file info - the filereader is asynchronous
    // so this will display
    var output = 'File attributes:<br>';
    output += 'name: ' + file.name + '<br>';
    output += 'type: ' + file.type + '<br>';
    output += 'size: ' + (file.size/1024).toFixed(2) + 'KB<br>';
    output += 'last modified date: ' + file.lastModifiedDate;

    // display the file attributes
    var fileAttributes = document.getElementById('fileAttributes');
    fileAttributes.innerHTML = output;

  } else {
    // inform user that the file is not a csv
    alert(file.name + ' is not a CSV file.');
  }
}

// cancel filereader function
function cancelFileReader() {

  // tell the filereader to abort
  textReader.abort();
}

// triggered filereader onloadstart handler
function onLoadStartHandler(evt) {

  // get our local element references
  var btnCancel = document.getElementById('btnCancel');
  var progMeter = document.getElementById('progMeter');
  var fileoutput = document.getElementById('fileoutput');

  // reset our cancel button, progress meter, and file output
  btnCancel.style.visibility = 'visible';
  progMeter.style.width = '0%';
  progMeter.innerHTML = 'loading...';
  fileoutput.innerHTML = '';
}

// triggered filereader onload handler
function onLoadHandler(evt) {

  // set the progress meter to 100% and hide the cancel button
  var progMeter = document.getElementById('progMeter');
  var btnCancel = document.getElementById('btnCancel');
  progMeter.style.width = '100%';
  progMeter.innerHTML = 'loaded.';
  btnCancel.style.visibility = 'hidden';

  // split the file into an array for processing
  var fileArr = evt.target.result.split('\n');

  // process each row and set to rows in a table
  // this is a simplistic processing for csv and
  // does not handle differences in csv format
  var strDiv = '<table>';
  for (var i=0; i<fileArr.length; i++) {
    strDiv += '<tr>';
    var fileLine = fileArr[i].split(',');
    for (var j=0; j<fileLine.length; j++) {
      strDiv += '<td>'+fileLine[j].trim()+'</td>';
    }
    strDiv += '</tr>';
  }
  strDiv += '</table>';

  // set the output
  var fileoutput = document.getElementById('fileoutput');
  fileoutput.innerHTML = strDiv;

}

// progress handler for the filereader
function updateProgress(evt) {

  // reference to our progress meter
  var progMeter = document.getElementById('progMeter');

  // compute and display the progress
  if (evt.lengthComputable) {
    var loaded = Math.round((evt.loaded / evt.total)*100);
    if (loaded < 100) {
      progMeter.style.width = loaded + '%';
    } else {
      progMeter.style.width = '100%';
    }
  }
}

// handle any abort of the filereader reading
function onAbortHandler(evt) {
  alert('File read cancelled');
}

// handle any error with the filereader
function onErrorHandler(evt) {
  switch(evt.target.error.code) {
    case evt.target.error.NOT_FOUND_ERR:
      alert('File Not Found!');
      break;
    case evt.target.error.SECURITY_ERR:
      alert('File security error.');
      break;
    case evt.target.error.ABORT_ERR:
      break;
    case evt.target.error.NOT_READABLE_ERR:
      alert('File is not readable.');
      break;
    case evt.target.error.ENCODING_ERR:
      alert('File encoding error.');
      break;
    default:
      alert('An error occurred reading the file.');
  };
}

// initialize the UI window
window.addeventlistener('load',init,false);

</script>
</head>
  <h1>Select a csv file to process.</h1>
  <section>
    <input type="file" id="input" onchange="handleFile(this)">
    <button id="btnCancel" onclick="cancelFileReader();">Cancel Processing</button>
  </section>
  <br>
  <section id="fileInfo">
    <div id="progHolder">
      <div id="progMeter"></div>
    </div>
    <div id="fileAttributes"></div>
  </section>
  <br>
  <div id="fileoutput"></div>
</body>
</html>
